<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿæµå¤±ç»Ÿè®¡ç³»ç»Ÿ - äº‘ç«¯åŒæ­¥ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 8px;
        }
        
        .import-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #28a745;
        }
        
        .import-section h3 {
            color: #155724;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .file-input {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: block;
            padding: 15px 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .data-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 4px 8px;
            text-align: left;
        }
        
        .preview-table th {
            background: #e9ecef;
            font-weight: bold;
        }
        
        .sync-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #dee2e6;
        }
        
        .sync-panel h3 {
            color: #495057;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-admin {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            font-size: 18px;
            padding: 15px 30px;
            border-radius: 12px;
        }
        
        .btn-admin:hover {
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.4);
        }
        
        .admin-panel {
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        /* åº•éƒ¨æ“ä½œæŒ‰é’®æ ·å¼ */
        .bottom-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            backdrop-filter: blur(10px);
            border-top: 3px solid #667eea;
            z-index: 1000;
        }
        
        .action-btn {
            flex: 1;
            max-width: 150px;
            padding: 12px 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 8px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .save-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .sync-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .sync-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        
        .back-btn {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(108, 117, 125, 0.4);
        }
        
        /* ä¸ºåº•éƒ¨æŒ‰é’®é¢„ç•™ç©ºé—´ */
        .student-list {
            padding-bottom: 100px;
        }
        
        .btn-sync {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .btn-import {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        
        .login-section {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
        }
        
        select, input {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            max-width: 300px;
        }
        
        .student-list {
            display: none;
            margin-top: 20px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            margin-bottom: 20px;
        }
        
        .student-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 300px;
        }
        
        .student-table th, .student-table td {
            border: 1px solid #ddd;
            padding: 10px 8px;
            text-align: center;
            font-size: 14px;
        }
        
        .student-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }
        
        .col-index { width: 12%; }
        .col-name { width: 28%; }
        .col-class { width: 40%; }
        .col-dropout { width: 20%; }
        
        .name-gender {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .gender {
            font-size: 11px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .alert {
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .data-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .data-info h4 {
            color: #1565c0;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            border: 1px solid #bbdefb;
        }
        
        .column-mapping {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ffeaa7;
        }
        
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .mapping-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mapping-item label {
            min-width: 60px;
            font-size: 12px;
            margin-bottom: 0;
        }
        
        .mapping-item select {
            flex: 1;
            padding: 6px 10px;
            font-size: 12px;
            max-width: none;
        }
        
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 15px; }
            .header h1 { font-size: 1.5em; }
            .student-table th, .student-table td { padding: 8px 6px; font-size: 13px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .mapping-grid { grid-template-columns: 1fr; }
            
            /* ç§»åŠ¨ç«¯åº•éƒ¨æŒ‰é’®é€‚é… */
            .bottom-actions {
                padding: 12px 10px;
                flex-direction: row;
                justify-content: space-between;
            }
            
            .action-btn {
                flex: 1;
                max-width: none;
                margin: 0 4px;
                padding: 10px 8px;
                font-size: 14px;
                border-radius: 8px;
            }
            
            .student-list {
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ å­¦ç”Ÿæµå¤±ç»Ÿè®¡ç³»ç»Ÿ</h1>
            <p>æ”¯æŒåŠ¨æ€å¯¼å…¥Excelæ•°æ®çš„æ™ºèƒ½ç»Ÿè®¡ç³»ç»Ÿ</p>
            <div style="margin-top: 8px; font-size: 0.8em; color: #28a745; font-weight: bold;">
                ğŸ“‹ åŠ¨æ€Excelå¯¼å…¥ | â˜ï¸ çœŸæ­£çš„äº‘ç«¯æ•°æ®åŒæ­¥ | ğŸ“± å¤šè®¾å¤‡å®æ—¶åŒæ­¥
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜åŠŸèƒ½æŒ‰é’® -->
        <div class="admin-panel">
            <div style="text-align: center; padding: 15px;">
                <button class="btn btn-admin" onclick="showAdminAuth()">
                    ğŸ”§ ç®¡ç†å‘˜åŠŸèƒ½
                </button>
                <p style="font-size: 12px; color: #6c757d; margin-top: 8px;">
                    æ•°æ®å¯¼å…¥ã€åˆ é™¤ç­‰ç®¡ç†åŠŸèƒ½éœ€è¦éªŒè¯ç 
                </p>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜éªŒè¯ç è¾“å…¥ -->
        <div id="adminAuth" class="admin-auth" style="display: none;">
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ffc107;">
                <h3 style="text-align: center; color: #856404; margin-bottom: 15px;">ğŸ” ç®¡ç†å‘˜éªŒè¯</h3>
                <div style="text-align: center;">
                    <input type="password" id="adminCode" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜éªŒè¯ç " 
                           style="padding: 12px 15px; border: 2px solid #ffc107; border-radius: 8px; font-size: 16px; width: 200px; text-align: center;">
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="verifyAdmin()" style="background: linear-gradient(45deg, #ffc107, #fd7e14);">
                            âœ… éªŒè¯
                        </button>
                        <button class="btn" onclick="hideAdminAuth()" style="background: #6c757d;">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜åŠŸèƒ½åŒºåŸŸï¼ˆéªŒè¯åæ˜¾ç¤ºï¼‰ -->
        <div id="adminSection" class="import-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>ğŸ“ ç®¡ç†å‘˜ - æ•°æ®ç®¡ç†</h3>
                <button class="btn" onclick="exitAdminMode()" style="background: #6c757d; font-size: 14px; padding: 8px 15px;">
                    ğŸšª é€€å‡ºç®¡ç†å‘˜æ¨¡å¼
                </button>
            </div>
            <p style="text-align: center; margin-bottom: 15px; color: #6c757d;">
                æ”¯æŒå¯¼å…¥Excelæ–‡ä»¶ï¼ˆ.xlsx/.xlsï¼‰ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å­¦ç”Ÿä¿¡æ¯
            </p>
            
            <div class="file-input-wrapper">
                <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileImport(event)">
                <label for="excelFile" class="file-input-label">
                    ğŸ“‚ é€‰æ‹©Excelæ–‡ä»¶ (.xlsx/.xls)
                </label>
            </div>
            
            <div id="columnMapping" class="column-mapping" style="display: none;">
                <h4 style="color: #856404; margin-bottom: 10px;">ğŸ”§ åˆ—æ˜ å°„é…ç½®</h4>
                <p style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">
                    è¯·é€‰æ‹©Excelä¸­å¯¹åº”çš„åˆ—åï¼Œç³»ç»Ÿå°†æ ¹æ®æ‚¨çš„é€‰æ‹©è‡ªåŠ¨åŒ¹é…æ•°æ®
                </p>
                <div class="mapping-grid">
                    <div class="mapping-item">
                        <label>å§“åï¼š</label>
                        <select id="nameColumn"></select>
                    </div>
                    <div class="mapping-item">
                        <label>æ€§åˆ«ï¼š</label>
                        <select id="genderColumn"></select>
                    </div>
                    <div class="mapping-item">
                        <label>å­¦é™¢ï¼š</label>
                        <select id="collegeColumn"></select>
                    </div>
                    <div class="mapping-item">
                        <label>ç­çº§ï¼š</label>
                        <select id="classColumn"></select>
                    </div>
                    <div class="mapping-item">
                        <label>ä¸“ä¸šï¼š</label>
                        <select id="majorColumn"></select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-import" onclick="processImportedData()">âœ… ç¡®è®¤å¯¼å…¥</button>
                    <button class="btn btn-danger" onclick="cancelImport()">âŒ å–æ¶ˆ</button>
                </div>
            </div>
            
            <div id="dataPreview" class="data-preview" style="display: none;">
                <h4 style="margin-bottom: 10px; color: #495057;">ğŸ“‹ æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰</h4>
                <div id="previewContent"></div>
            </div>
            
            <!-- ç®¡ç†å‘˜ä¸“ç”¨åŠŸèƒ½ -->
            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px solid #007bff;">
                <h4 style="color: #0056b3; margin-bottom: 15px;">ğŸ“Š æ•°æ®å¯¼å‡ºåŠŸèƒ½</h4>
                <p style="text-align: center; margin-bottom: 15px; color: #6c757d;">
                    å¯¼å‡ºå½“å‰æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼Œç”ŸæˆExcelæŠ¥è¡¨
                </p>
                <div style="text-align: center;">
                    <button class="btn" onclick="exportDataAdmin()" style="background: linear-gradient(45deg, #28a745, #20c997);">
                        ğŸ“Š å¯¼å‡ºExcelæŠ¥è¡¨
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding: 15px; background: #f8d7da; border-radius: 8px; border: 2px solid #dc3545;">
                <h4 style="color: #721c24; margin-bottom: 10px;">âš ï¸ å±é™©æ“ä½œåŒºåŸŸ</h4>
                <div style="text-align: center;">
                    <button class="btn" onclick="clearAllDataAdmin()" style="background: linear-gradient(45deg, #dc3545, #c82333); color: white;">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
                    </button>
                </div>
                <p style="font-size: 12px; color: #721c24; margin-top: 8px; text-align: center;">
                    æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å­¦ç”Ÿæ•°æ®å’Œæµå¤±è®°å½•ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼
                </p>
            </div>
        </div>
        
        <div class="data-info" id="dataInfo">
            <h4>ğŸ“Š å½“å‰æ•°æ®æ¦‚å†µ</h4>
            <div id="dataStats">æš‚æ— æ•°æ®ï¼Œè¯·å¯¼å…¥Excelæ–‡ä»¶</div>
        </div>
        
        <div class="sync-panel">
            <h3>â˜ï¸ æ•°æ®åŒæ­¥çŠ¶æ€</h3>
            <div id="syncStatus" style="padding: 12px; background: #e3f2fd; border-radius: 8px; text-align: center; font-size: 14px; color: #1565c0;">
                ğŸ“¡ å‡†å¤‡å°±ç»ª
            </div>
            <p style="text-align: center; margin-top: 10px; font-size: 12px; color: #6c757d;">
                æ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ï¼Œå¤šè®¾å¤‡è®¿é—®æ—¶è‡ªåŠ¨è·å–æœ€æ–°æ•°æ®
            </p>
        </div>
        
        <div id="loginSection" class="login-section">
            <div class="form-group">
                <label for="collegeSelect">ğŸ« é€‰æ‹©å­¦é™¢ï¼š</label>
                <select id="collegeSelect" onchange="loadClassesByCollege()">
                    <option value="">è¯·å…ˆå¯¼å…¥æ•°æ®æˆ–é€‰æ‹©å­¦é™¢</option>
                </select>
            </div>
            <div class="form-group">
                <label for="classSelect">ğŸ“š é€‰æ‹©ç­çº§ï¼š</label>
                <select id="classSelect" disabled>
                    <option value="">è¯·å…ˆé€‰æ‹©å­¦é™¢</option>
                </select>
            </div>
            <button class="btn" onclick="loadClass()">è¿›å…¥ç­çº§ç®¡ç†</button>
        </div>
        
        <div id="studentSection" class="student-list">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <h2 id="currentClassName">å½“å‰ç­çº§</h2>
                <p id="currentCollegeName"></p>
                <p>è¯·åœ¨æµå¤±çš„å­¦ç”Ÿåé¢å‹¾é€‰"å·²æµå¤±"æ ‡è®°ï¼Œç„¶åç‚¹å‡»ä¿å­˜æ•°æ®</p>
            </div>
            
            <div class="table-wrapper">
                <table class="student-table" id="studentTable">
                    <thead>
                        <tr>
                            <th class="col-index">åºå·</th>
                            <th class="col-name">å§“å</th>
                            <th class="col-class">ç­çº§</th>
                            <th class="col-dropout">æµå¤±çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                    </tbody>
                </table>
            </div>
            
            <!-- åº•éƒ¨æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <div class="bottom-actions">
                <button class="action-btn save-btn" onclick="saveClassData()">
                    ğŸ’¾ ä¿å­˜æ•°æ®
                </button>
                <button class="action-btn sync-btn" onclick="manualSync()">
                    ğŸ”„ ç«‹å³åŒæ­¥
                </button>
                <button class="action-btn back-btn" onclick="backToLogin()">
                    ğŸ”™ è¿”å›
                </button>
            </div>
        </div>
        
        
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // å­¦ç”Ÿæ•°æ®å­˜å‚¨
        let studentData = [];
        let rawExcelData = null;
        let excelColumns = [];
        
        // æœ¬åœ°æ•°æ®å­˜å‚¨
        let dropoutData = JSON.parse(localStorage.getItem('dropoutData') || '{}');
        let classStatus = JSON.parse(localStorage.getItem('classStatus') || '{}');
        
        // åˆå§‹åŒ–é¡µé¢
        async function init() {
            console.log('åŠ¨æ€å¯¼å…¥ç³»ç»Ÿåˆå§‹åŒ–...');
            updateSyncStatus('loading');
            
            // é¦–å…ˆå°è¯•ä»äº‘ç«¯åŠ è½½æ•°æ®
            try {
                const response = await fetch('/api/data');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const cloudData = result.data;
                    
                    // å¦‚æœäº‘ç«¯æœ‰æ•°æ®ï¼Œä½¿ç”¨äº‘ç«¯æ•°æ®
                    if (cloudData.studentData && cloudData.studentData.length > 0) {
                        studentData = cloudData.studentData;
                        dropoutData = cloudData.dropoutData || {};
                        classStatus = cloudData.classStatus || {};
                        
                        // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºå¤‡ä»½
                        localStorage.setItem('studentData', JSON.stringify(studentData));
                        localStorage.setItem('dropoutData', JSON.stringify(dropoutData));
                        localStorage.setItem('classStatus', JSON.stringify(classStatus));
                        
                        console.log('âœ… å·²ä»äº‘ç«¯åŠ è½½æ•°æ®:', studentData.length + 'ä¸ªå­¦ç”Ÿ');
                        showAlert('âœ… å·²ä»äº‘ç«¯åŠ è½½æœ€æ–°æ•°æ®ï¼', 'success');
                        updateSyncStatus('synced');
                    } else {
                        // äº‘ç«¯æ— æ•°æ®ï¼Œå°è¯•åŠ è½½æœ¬åœ°æ•°æ®
                        loadLocalData();
                        updateSyncStatus('local');
                    }
                } else {
                    // äº‘ç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
                    loadLocalData();
                    updateSyncStatus('local');
                }
            } catch (error) {
                console.warn('äº‘ç«¯æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
                loadLocalData();
                updateSyncStatus('offline');
            }
            
            // æ›´æ–°ç•Œé¢
            updateDataInfo();
            loadCollegeOptions();
        }
        
        // åŠ è½½æœ¬åœ°æ•°æ®
        function loadLocalData() {
            const savedStudentData = localStorage.getItem('studentData');
            if (savedStudentData) {
                try {
                    studentData = JSON.parse(savedStudentData);
                    console.log('ğŸ“± å·²åŠ è½½æœ¬åœ°æ•°æ®:', studentData.length + 'ä¸ªå­¦ç”Ÿ');
                } catch (error) {
                    console.error('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:', error);
                    studentData = [];
                }
            }
        }
        
        // å¤„ç†Excelæ–‡ä»¶å¯¼å…¥
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showAlert('è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsæ ¼å¼ï¼‰', 'warning');
                return;
            }
            
            showAlert('æ­£åœ¨è¯»å–Excelæ–‡ä»¶...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // è½¬æ¢ä¸ºJSONæ•°æ®
                    rawExcelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (rawExcelData.length < 2) {
                        showAlert('Excelæ–‡ä»¶æ•°æ®ä¸è¶³ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹', 'warning');
                        return;
                    }
                    
                    // è·å–åˆ—åï¼ˆç¬¬ä¸€è¡Œï¼‰
                    excelColumns = rawExcelData[0];
                    
                    showExcelPreview();
                    showColumnMapping();
                    
                    showAlert('Excelæ–‡ä»¶è¯»å–æˆåŠŸï¼è¯·é…ç½®åˆ—æ˜ å°„', 'success');
                    
                } catch (error) {
                    console.error('Excelè¯»å–é”™è¯¯:', error);
                    showAlert('Excelæ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'danger');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // æ˜¾ç¤ºExcelæ•°æ®é¢„è§ˆ
        function showExcelPreview() {
            const previewDiv = document.getElementById('dataPreview');
            const contentDiv = document.getElementById('previewContent');
            
            let tableHTML = '<table class="preview-table"><thead><tr>';
            
            // è¡¨å¤´
            excelColumns.forEach(col => {
                tableHTML += `<th>${col || 'ç©ºåˆ—'}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // æ•°æ®è¡Œï¼ˆæœ€å¤šæ˜¾ç¤º5è¡Œï¼‰
            const maxRows = Math.min(6, rawExcelData.length);
            for (let i = 1; i < maxRows; i++) {
                tableHTML += '<tr>';
                excelColumns.forEach((col, index) => {
                    const cellValue = rawExcelData[i][index] || '';
                    tableHTML += `<td>${cellValue}</td>`;
                });
                tableHTML += '</tr>';
            }
            
            tableHTML += '</tbody></table>';
            contentDiv.innerHTML = tableHTML;
            previewDiv.style.display = 'block';
        }
        
        // æ˜¾ç¤ºåˆ—æ˜ å°„é…ç½®
        function showColumnMapping() {
            const mappingDiv = document.getElementById('columnMapping');
            
            // ä¸ºæ¯ä¸ªæ˜ å°„ä¸‹æ‹‰æ¡†æ·»åŠ é€‰é¡¹
            const selects = ['nameColumn', 'genderColumn', 'collegeColumn', 'classColumn', 'majorColumn'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ—</option>';
                
                excelColumns.forEach((col, index) => {
                    if (col) {
                        select.innerHTML += `<option value="${index}">${col}</option>`;
                    }
                });
            });
            
            // æ™ºèƒ½åŒ¹é…å¸¸ç”¨åˆ—å
            autoMatchColumns();
            
            // æ˜¾ç¤ºåŒ¹é…æç¤º
            showMatchingTips();
            
            mappingDiv.style.display = 'block';
        }
        
        // æ™ºèƒ½åŒ¹é…åˆ—å - å¢å¼ºç‰ˆ
        function autoMatchColumns() {
            const mappings = {
                'nameColumn': [
                    // åŸºç¡€åŒ¹é…
                    'å§“å', 'å­¦ç”Ÿå§“å', 'åå­—', 'å­¦å‘˜å§“å', 'å§“  å',
                    // è‹±æ–‡åŒ¹é…
                    'name', 'student_name', 'studentname',
                    // å¸¸è§å˜ä½“
                    'å§“å:', 'å§“åï¼š', 'å­¦ç”Ÿå§“å:', 'å­¦ç”Ÿå§“åï¼š',
                    'çœŸå®å§“å', 'å­¦å‘˜åå­—', 'å­¦ç”Ÿåå­—', 'å­¦å‘˜çœŸå®å§“å'
                ],
                'genderColumn': [
                    // åŸºç¡€åŒ¹é…
                    'æ€§åˆ«', 'æ€§  åˆ«', 'æ€§åˆ«:', 'æ€§åˆ«ï¼š',
                    // è‹±æ–‡åŒ¹é…
                    'gender', 'sex',
                    // æè¿°æ€§åŒ¹é…
                    'ç”·å¥³', 'ç”·/å¥³', 'å­¦ç”Ÿæ€§åˆ«', 'å­¦å‘˜æ€§åˆ«'
                ],
                'collegeColumn': [
                    // å­¦é™¢ç›¸å…³
                    'å­¦é™¢', 'é™¢ç³»', 'æ‰€å±å­¦é™¢', 'å­¦é™¢åç§°', 'é™¢ç³»åç§°',
                    'å­¦  é™¢', 'å­¦é™¢:', 'å­¦é™¢ï¼š', 'æ‰€åœ¨å­¦é™¢',
                    // è‹±æ–‡åŒ¹é…
                    'college', 'school', 'department',
                    // ç³»éƒ¨ç›¸å…³
                    'ç³»éƒ¨', 'ç³»', 'æ‰€å±ç³»éƒ¨', 'ç³»éƒ¨åç§°', 'å­¦ç”Ÿå­¦é™¢'
                ],
                'classColumn': [
                    // ç­çº§ç›¸å…³
                    'ç­çº§', 'ç­', 'æ‰€åœ¨ç­çº§', 'ç­çº§åç§°', 'å­¦ç”Ÿç­çº§',
                    'ç­  çº§', 'ç­çº§:', 'ç­çº§ï¼š', 'æ‰€å±ç­çº§',
                    // è‹±æ–‡åŒ¹é…  
                    'class', 'className', 'student_class',
                    // å¹´çº§ç­çº§
                    'å¹´çº§ç­çº§', 'å°±è¯»ç­çº§', 'å­¦å‘˜ç­çº§', 'åœ¨è¯»ç­çº§'
                ],
                'majorColumn': [
                    // ä¸“ä¸šç›¸å…³
                    'ä¸“ä¸š', 'æ‰€å­¦ä¸“ä¸š', 'ä¸“ä¸šåç§°', 'å­¦ç”Ÿä¸“ä¸š', 'å°±è¯»ä¸“ä¸š',
                    'ä¸“  ä¸š', 'ä¸“ä¸š:', 'ä¸“ä¸šï¼š', 'æ‰€å±ä¸“ä¸š',
                    // è‹±æ–‡åŒ¹é…
                    'major', 'specialty', 'subject',
                    // å…¶ä»–è¡¨è¿°
                    'å­¦ä¹ ä¸“ä¸š', 'å­¦å‘˜ä¸“ä¸š', 'ä¸“ä¸šæ–¹å‘', 'ä¸»ä¿®ä¸“ä¸š'
                ]
            };
            
            Object.keys(mappings).forEach(selectId => {
                const select = document.getElementById(selectId);
                const keywords = mappings[selectId];
                let bestMatch = -1;
                let bestScore = 0;
                
                for (let i = 0; i < excelColumns.length; i++) {
                    const col = excelColumns[i];
                    if (!col) continue;
                    
                    // æ¸…ç†åˆ—åï¼ˆå»é™¤ç©ºæ ¼ã€æ ‡ç‚¹ï¼‰
                    const cleanCol = col.replace(/[\s\:\ï¼š\-\â€”]/g, '').toLowerCase();
                    
                    // è®¡ç®—åŒ¹é…åˆ†æ•°
                    let score = 0;
                    for (let keyword of keywords) {
                        const cleanKeyword = keyword.replace(/[\s\:\ï¼š\-\â€”]/g, '').toLowerCase();
                        
                        // å®Œå…¨åŒ¹é… - æœ€é«˜åˆ†
                        if (cleanCol === cleanKeyword) {
                            score = 100;
                            break;
                        }
                        // åŒ…å«åŒ¹é… - é«˜åˆ†
                        else if (cleanCol.includes(cleanKeyword) || cleanKeyword.includes(cleanCol)) {
                            score = Math.max(score, 80);
                        }
                        // æ¨¡ç³ŠåŒ¹é… - ä¸­ç­‰åˆ†
                        else if (keyword.length > 2 && col.includes(keyword.substring(0, 2))) {
                            score = Math.max(score, 50);
                        }
                    }
                    
                    // è®°å½•æœ€ä½³åŒ¹é…
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = i;
                    }
                }
                
                // è®¾ç½®æœ€ä½³åŒ¹é…ï¼ˆåˆ†æ•°è¦è¾¾åˆ°50ä»¥ä¸Šæ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆåŒ¹é…ï¼‰
                if (bestMatch >= 0 && bestScore >= 50) {
                    select.value = bestMatch;
                    console.log(`${selectId} åŒ¹é…åˆ°åˆ— "${excelColumns[bestMatch]}" (åˆ†æ•°: ${bestScore})`);
                }
            });
        }
        
        // æ•°æ®æ¸…æ´—è¾…åŠ©å‡½æ•°
        function cleanString(value) {
            if (!value) return '';
            return String(value)
                .trim()                          // å»é™¤é¦–å°¾ç©ºæ ¼
                .replace(/\s+/g, ' ')           // åˆå¹¶å¤šä¸ªç©ºæ ¼ä¸ºä¸€ä¸ª
                .replace(/[\r\n\t]/g, '')       // å»é™¤æ¢è¡Œç¬¦å’Œåˆ¶è¡¨ç¬¦
                .replace(/[""'']/g, '"')        // ç»Ÿä¸€å¼•å·æ ¼å¼
                .replace(/[ï¼ˆï¼‰]/g, match => match === 'ï¼ˆ' ? '(' : ')'); // ç»Ÿä¸€æ‹¬å·æ ¼å¼
        }
        
        function normalizeGender(value) {
            if (!value) return 'æœªçŸ¥';
            const cleanValue = cleanString(value).toLowerCase();
            
            // ç”·æ€§æ ‡è¯†
            if (['ç”·', 'male', 'm', '1', 'boy', 'ç”·æ€§'].includes(cleanValue)) {
                return 'ç”·';
            }
            // å¥³æ€§æ ‡è¯†  
            if (['å¥³', 'female', 'f', '0', 'girl', 'å¥³æ€§'].includes(cleanValue)) {
                return 'å¥³';
            }
            
            return 'æœªçŸ¥';
        }
        
        // æ˜¾ç¤ºåŒ¹é…æç¤º
        function showMatchingTips() {
            const fieldNames = {
                'nameColumn': 'å§“å',
                'genderColumn': 'æ€§åˆ«', 
                'collegeColumn': 'å­¦é™¢',
                'classColumn': 'ç­çº§',
                'majorColumn': 'ä¸“ä¸š'
            };
            
            let matchedFields = [];
            let unmatchedFields = [];
            
            Object.keys(fieldNames).forEach(selectId => {
                const select = document.getElementById(selectId);
                const fieldName = fieldNames[selectId];
                
                if (select.value) {
                    const columnName = excelColumns[select.value];
                    matchedFields.push(`âœ… ${fieldName} â†’ "${columnName}"`);
                } else {
                    unmatchedFields.push(`âŒ ${fieldName}`);
                }
            });
            
            let tipHTML = '<div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
            tipHTML += '<h4 style="color: #155724; margin-bottom: 10px;">ğŸ¤– æ™ºèƒ½è¯†åˆ«ç»“æœ</h4>';
            
            if (matchedFields.length > 0) {
                tipHTML += '<div style="margin-bottom: 10px;">';
                tipHTML += '<strong style="color: #28a745;">å·²è‡ªåŠ¨åŒ¹é…ï¼š</strong><br>';
                tipHTML += matchedFields.join('<br>');
                tipHTML += '</div>';
            }
            
            if (unmatchedFields.length > 0) {
                tipHTML += '<div>';
                tipHTML += '<strong style="color: #856404;">éœ€è¦æ‰‹åŠ¨é€‰æ‹©ï¼š</strong><br>';
                tipHTML += unmatchedFields.join(', ');
                tipHTML += '</div>';
            }
            
            tipHTML += '<div style="margin-top: 10px; font-size: 12px; color: #666;">';
            tipHTML += 'ğŸ’¡ æç¤ºï¼šå§“åå’Œç­çº§æ˜¯å¿…å¡«é¡¹ï¼Œå…¶ä»–å­—æ®µå¯é€‰æ‹©"è¯·é€‰æ‹©åˆ—"è·³è¿‡';
            tipHTML += '</div>';
            tipHTML += '</div>';
            
            // åœ¨åˆ—æ˜ å°„åŒºåŸŸå‰æ’å…¥æç¤º
            const mappingDiv = document.getElementById('columnMapping');
            const existingTip = mappingDiv.querySelector('.matching-tips');
            if (existingTip) {
                existingTip.remove();
            }
            
            const tipDiv = document.createElement('div');
            tipDiv.className = 'matching-tips';
            tipDiv.innerHTML = tipHTML;
            mappingDiv.insertBefore(tipDiv, mappingDiv.firstChild);
        }
        
        // å¤„ç†å¯¼å…¥çš„æ•°æ®
        function processImportedData() {
            const nameCol = document.getElementById('nameColumn').value;
            const genderCol = document.getElementById('genderColumn').value;
            const collegeCol = document.getElementById('collegeColumn').value;
            const classCol = document.getElementById('classColumn').value;
            const majorCol = document.getElementById('majorColumn').value;
            
            // éªŒè¯å¿…è¦åˆ—
            if (!nameCol || !classCol) {
                showAlert('å§“åå’Œç­çº§æ˜¯å¿…å¡«åˆ—ï¼Œè¯·é€‰æ‹©å¯¹åº”çš„Excelåˆ—', 'warning');
                return;
            }
            
            try {
                studentData = [];
                
                // æ•°æ®å¤„ç†ç»Ÿè®¡
                let totalRows = rawExcelData.length - 1; // å‡å»è¡¨å¤´
                let validRows = 0;
                let invalidRows = 0;
                
                // å¤„ç†æ•°æ®è¡Œï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                for (let i = 1; i < rawExcelData.length; i++) {
                    const row = rawExcelData[i];
                    
                    // æ•°æ®æ¸…æ´—å’ŒéªŒè¯
                    const rawName = row[nameCol];
                    const rawClass = row[classCol];
                    
                    // è·³è¿‡å®Œå…¨ç©ºè¡Œ
                    if (!rawName && !rawClass && !row[genderCol] && !row[collegeCol]) {
                        invalidRows++;
                        continue;
                    }
                    
                    // æ£€æŸ¥å¿…å¡«å­—æ®µ
                    if (!rawName || !rawClass) {
                        invalidRows++;
                        console.warn(`ç¬¬${i+1}è¡Œæ•°æ®ä¸å®Œæ•´: å§“å="${rawName}", ç­çº§="${rawClass}"`);
                        continue;
                    }
                    
                    // æ•°æ®æ¸…æ´—å’Œæ ‡å‡†åŒ–
                    const cleanName = cleanString(rawName);
                    const cleanClass = cleanString(rawClass);
                    const cleanGender = normalizeGender(row[genderCol]);
                    const cleanCollege = cleanString(row[collegeCol]) || 'æœªåˆ†é…å­¦é™¢';
                    const cleanMajor = cleanString(row[majorCol]) || 'æœªæŒ‡å®šä¸“ä¸š';
                    
                    // éªŒè¯æ¸…æ´—åçš„æ•°æ®
                    if (cleanName.length === 0 || cleanClass.length === 0) {
                        invalidRows++;
                        continue;
                    }
                    
                    const student = {
                        id: i, // ä½¿ç”¨è¡Œå·ä½œä¸ºID
                        name: cleanName,
                        gender: cleanGender,
                        collegeName: cleanCollege,
                        className: cleanClass,
                        major: cleanMajor
                    };
                    
                    studentData.push(student);
                    validRows++;
                }
                
                console.log(`æ•°æ®å¤„ç†å®Œæˆ: æ€»è¡Œæ•°=${totalRows}, æœ‰æ•ˆ=${validRows}, æ— æ•ˆ=${invalidRows}`);
                
                if (studentData.length === 0) {
                    showAlert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å­¦ç”Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶å†…å®¹', 'warning');
                    return;
                }
                
                // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('studentData', JSON.stringify(studentData));
                
                // æ¸…ç©ºä¹‹å‰çš„æµå¤±æ•°æ®ï¼ˆå› ä¸ºæ˜¯æ–°çš„å­¦ç”Ÿåå•ï¼‰
                if (confirm('å¯¼å…¥æ–°æ•°æ®å°†æ¸…ç©ºä¹‹å‰çš„æµå¤±ç»Ÿè®¡è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    dropoutData = {};
                    classStatus = {};
                    localStorage.setItem('dropoutData', JSON.stringify(dropoutData));
                    localStorage.setItem('classStatus', JSON.stringify(classStatus));
                }
                
                // æ›´æ–°ç•Œé¢
                updateDataInfo();
                loadCollegeOptions();
                
                // éšè—å¯¼å…¥é…ç½®
                document.getElementById('columnMapping').style.display = 'none';
                document.getElementById('dataPreview').style.display = 'none';
                
                // æ˜¾ç¤ºè¯¦ç»†çš„å¯¼å…¥ç»Ÿè®¡
                let importMsg = `âœ… æ•°æ®å¯¼å…¥å®Œæˆï¼`;
                importMsg += `\nğŸ“Š å¤„ç†ç»Ÿè®¡: æ€»è®¡${totalRows}è¡Œï¼ŒæˆåŠŸå¯¼å…¥${validRows}ä¸ªå­¦ç”Ÿ`;
                if (invalidRows > 0) {
                    importMsg += `ï¼Œè·³è¿‡${invalidRows}è¡Œæ— æ•ˆæ•°æ®`;
                }
                importMsg += `\nâ˜ï¸ æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...`;
                
                showAlert(importMsg, 'success');
                
                // åŒæ­¥åˆ°äº‘ç«¯
                manualSync();
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                document.getElementById('excelFile').value = '';
                
            } catch (error) {
                console.error('æ•°æ®å¤„ç†é”™è¯¯:', error);
                showAlert('æ•°æ®å¤„ç†å¤±è´¥ï¼š' + error.message, 'danger');
            }
        }
        
        // å–æ¶ˆå¯¼å…¥
        function cancelImport() {
            document.getElementById('columnMapping').style.display = 'none';
            document.getElementById('dataPreview').style.display = 'none';
            document.getElementById('excelFile').value = '';
            rawExcelData = null;
            excelColumns = [];
        }
        
        // æ›´æ–°æ•°æ®æ¦‚å†µ
        function updateDataInfo() {
            const infoDiv = document.getElementById('dataStats');
            
            if (studentData.length === 0) {
                infoDiv.innerHTML = 'æš‚æ— æ•°æ®ï¼Œè¯·å¯¼å…¥Excelæ–‡ä»¶';
                return;
            }
            
            // ç»Ÿè®¡å„å­¦é™¢æ•°æ®
            const collegeStats = {};
            studentData.forEach(student => {
                const college = student.collegeName;
                if (!collegeStats[college]) {
                    collegeStats[college] = new Set();
                }
                collegeStats[college].add(student.className);
            });
            
            let statsHTML = `<div class="stats-grid">`;
            statsHTML += `<div class="stat-item"><strong>${studentData.length}</strong><br>æ€»å­¦ç”Ÿæ•°</div>`;
            statsHTML += `<div class="stat-item"><strong>${Object.keys(collegeStats).length}</strong><br>å­¦é™¢æ•°</div>`;
            
            const totalClasses = Object.values(collegeStats).reduce((sum, classes) => sum + classes.size, 0);
            statsHTML += `<div class="stat-item"><strong>${totalClasses}</strong><br>ç­çº§æ•°</div>`;
            
            Object.keys(collegeStats).forEach(college => {
                const classCount = collegeStats[college].size;
                const studentCount = studentData.filter(s => s.collegeName === college).length;
                statsHTML += `<div class="stat-item"><strong>${college}</strong><br>${studentCount}äºº ${classCount}ç­</div>`;
            });
            
            statsHTML += `</div>`;
            infoDiv.innerHTML = statsHTML;
        }
        
        // åŠ è½½å­¦é™¢é€‰é¡¹
        function loadCollegeOptions() {
            const colleges = [...new Set(studentData.map(s => s.collegeName))].sort();
            const collegeSelect = document.getElementById('collegeSelect');
            
            collegeSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å­¦é™¢</option>';
            colleges.forEach(college => {
                const option = document.createElement('option');
                option.value = college;
                option.textContent = college + 'å­¦é™¢';
                collegeSelect.appendChild(option);
            });
        }
        
        // æ ¹æ®å­¦é™¢åŠ è½½ç­çº§
        function loadClassesByCollege() {
            const selectedCollege = document.getElementById('collegeSelect').value;
            const classSelect = document.getElementById('classSelect');
            
            if (!selectedCollege) {
                classSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å­¦é™¢</option>';
                classSelect.disabled = true;
                return;
            }
            
            const classes = [...new Set(studentData
                .filter(s => s.collegeName === selectedCollege)
                .map(s => s.className))].sort();
            
            classSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç­çº§</option>';
            classSelect.disabled = false;
            
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelect.appendChild(option);
            });
        }
        
        // åŠ è½½ç­çº§
        function loadClass() {
            const selectedClass = document.getElementById('classSelect').value;
            if (!selectedClass) {
                showAlert('è¯·å…ˆé€‰æ‹©ç­çº§ï¼', 'warning');
                return;
            }
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('studentSection').style.display = 'block';
            document.getElementById('currentClassName').textContent = selectedClass;
            
            loadStudents(selectedClass);
        }
        
        // åŠ è½½å­¦ç”Ÿåˆ—è¡¨
        function loadStudents(className) {
            const students = studentData.filter(s => s.className === className);
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            students.forEach((student, index) => {
                const row = document.createElement('tr');
                const isDropout = dropoutData[student.id] || false;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="name-gender">
                            <span>${student.name}</span>
                            <span class="gender">${student.gender}</span>
                        </div>
                    </td>
                    <td>${student.className}</td>
                    <td>
                        <input type="checkbox" 
                               id="dropout_${student.id}"
                               ${isDropout ? 'checked' : ''}
                               onchange="toggleDropout(${student.id})">
                        <label for="dropout_${student.id}">å·²æµå¤±</label>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // åˆ‡æ¢æµå¤±çŠ¶æ€
        function toggleDropout(studentId) {
            const checkbox = document.getElementById(`dropout_${studentId}`);
            dropoutData[studentId] = checkbox.checked;
            localStorage.setItem('dropoutData', JSON.stringify(dropoutData));
            
            // è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
            manualSync();
        }
        
        // ä¿å­˜ç­çº§æ•°æ®
        function saveClassData() {
            const className = document.getElementById('currentClassName').textContent;
            classStatus[className] = true;
            localStorage.setItem('classStatus', JSON.stringify(classStatus));
            
            showAlert(`${className} æ•°æ®ä¿å­˜æˆåŠŸï¼æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...`, 'success');
            
            // è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
            manualSync();
        }
        
        // è¿”å›ç™»å½•é¡µé¢
        function backToLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('studentSection').style.display = 'none';
        }
        
        // æ‰‹åŠ¨åŒæ­¥åˆ°äº‘ç«¯
        async function manualSync() {
            updateSyncStatus('syncing');
            
            try {
                const response = await fetch('/api/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentData: studentData,
                        dropoutData: dropoutData,
                        classStatus: classStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºå¤‡ä»½
                    localStorage.setItem('studentData', JSON.stringify(studentData));
                    localStorage.setItem('dropoutData', JSON.stringify(dropoutData));
                    localStorage.setItem('classStatus', JSON.stringify(classStatus));
                    localStorage.setItem('lastSyncTime', result.timestamp);
                    
                    showAlert('âœ… æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯ï¼æ‰€æœ‰è®¾å¤‡ç°åœ¨å¯ä»¥è®¿é—®æœ€æ–°æ•°æ®', 'success');
                    updateSyncStatus('synced');
                } else {
                    throw new Error(result.message || 'åŒæ­¥å¤±è´¥');
                }
            } catch (error) {
                console.error('åŒæ­¥é”™è¯¯:', error);
                showAlert('âŒ äº‘ç«¯åŒæ­¥å¤±è´¥: ' + error.message + 'ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°', 'warning');
                
                // å¤±è´¥æ—¶ä»ç„¶ä¿å­˜åˆ°æœ¬åœ°
                localStorage.setItem('studentData', JSON.stringify(studentData));
                localStorage.setItem('dropoutData', JSON.stringify(dropoutData));
                localStorage.setItem('classStatus', JSON.stringify(classStatus));
                
                updateSyncStatus('error');
            }
        }
        
        // ä¸‹è½½å¤‡ä»½
        function downloadBackup() {
            const backupData = {
                studentData: studentData,
                dropoutData: dropoutData,
                classStatus: classStatus,
                exportTime: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `å­¦ç”Ÿæµå¤±ç»Ÿè®¡å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('ğŸ“¥ å¤‡ä»½æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼', 'success');
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                studentData = [];
                dropoutData = {};
                classStatus = {};
                
                localStorage.removeItem('studentData');
                localStorage.removeItem('dropoutData');
                localStorage.removeItem('classStatus');
                
                updateDataInfo();
                document.getElementById('collegeSelect').innerHTML = '<option value="">è¯·å…ˆå¯¼å…¥æ•°æ®æˆ–é€‰æ‹©å­¦é™¢</option>';
                document.getElementById('classSelect').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å­¦é™¢</option>';
                
                showAlert('ğŸ—‘ï¸ æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼', 'warning');
                updateSyncStatus();
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const exportCode = document.getElementById('exportCode').value;
            if (exportCode !== '9090') {
                showAlert('å¯¼å‡ºéªŒè¯ç é”™è¯¯ï¼è¯·è¾“å…¥ï¼š9090', 'warning');
                return;
            }
            
            if (studentData.length === 0) {
                showAlert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆå¯¼å…¥å­¦ç”Ÿæ•°æ®', 'warning');
                return;
            }
            
            const exportStudentData = studentData.map(student => ({
                'åºå·': student.id,
                'å§“å': student.name,
                'æ€§åˆ«': student.gender,
                'å­¦é™¢': student.collegeName,
                'ç­çº§': student.className,
                'ä¸“ä¸š': student.major,
                'æ˜¯å¦æµå¤±': dropoutData[student.id] ? 'æ˜¯' : 'å¦'
            }));
            
            // ç»Ÿè®¡æ•°æ®
            const totalStudents = studentData.length;
            const dropoutCount = Object.values(dropoutData).filter(status => status).length;
            
            const summaryData = [
                {'é¡¹ç›®': 'æ€»å­¦ç”Ÿæ•°', 'æ•°å€¼': totalStudents},
                {'é¡¹ç›®': 'æµå¤±å­¦ç”Ÿæ•°', 'æ•°å€¼': dropoutCount},
                {'é¡¹ç›®': 'åœ¨æ ¡å­¦ç”Ÿæ•°', 'æ•°å€¼': totalStudents - dropoutCount},
                {'é¡¹ç›®': 'æµå¤±ç‡', 'æ•°å€¼': `${(dropoutCount / totalStudents * 100).toFixed(2)}%`}
            ];
            
            const wb = XLSX.utils.book_new();
            
            // å­¦ç”Ÿè¯¦ç»†æ•°æ®
            const ws1 = XLSX.utils.json_to_sheet(exportStudentData);
            XLSX.utils.book_append_sheet(wb, ws1, "å­¦ç”Ÿè¯¦ç»†æ•°æ®");
            
            // ç»Ÿè®¡æ±‡æ€»
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, "ç»Ÿè®¡æ±‡æ€»");
            
            const timestamp = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `å­¦ç”Ÿæµå¤±ç»Ÿè®¡_${timestamp}.xlsx`);
            
            showAlert('ğŸ“Š Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼', 'success');
        }
        
        // æ›´æ–°åŒæ­¥çŠ¶æ€
        function updateSyncStatus(status = 'ready') {
            const statusEl = document.getElementById('syncStatus');
            const timestamp = new Date().toLocaleTimeString();
            
            switch (status) {
                case 'loading':
                    statusEl.innerHTML = 'ğŸ”„ æ­£åœ¨ä»äº‘ç«¯åŠ è½½æ•°æ®...';
                    statusEl.style.background = '#fff3cd';
                    break;
                case 'syncing':
                    statusEl.innerHTML = 'â¬†ï¸ æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...';
                    statusEl.style.background = '#fff3cd';
                    break;
                case 'synced':
                    statusEl.innerHTML = `â˜ï¸ äº‘ç«¯åŒæ­¥å®Œæˆ - ${timestamp}`;
                    statusEl.style.background = '#d4edda';
                    break;
                case 'saved':
                    statusEl.innerHTML = `ğŸ’¾ æ•°æ®å·²ä¿å­˜ - ${timestamp}`;
                    statusEl.style.background = '#d4edda';
                    break;
                case 'local':
                    statusEl.innerHTML = `ğŸ“± ä½¿ç”¨æœ¬åœ°æ•°æ® - ${timestamp}`;
                    statusEl.style.background = '#d1ecf1';
                    break;
                case 'offline':
                    statusEl.innerHTML = `ğŸ“¡ ç¦»çº¿æ¨¡å¼ - ${timestamp}`;
                    statusEl.style.background = '#f8d7da';
                    break;
                case 'error':
                    statusEl.innerHTML = `âŒ åŒæ­¥å¤±è´¥ - ${timestamp}`;
                    statusEl.style.background = '#f8d7da';
                    break;
                default:
                    statusEl.innerHTML = `ğŸ“¡ å‡†å¤‡å°±ç»ª - ${timestamp}`;
                    statusEl.style.background = '#e3f2fd';
            }
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        // ç®¡ç†å‘˜æƒé™æ§åˆ¶
        let isAdminMode = false;
        const ADMIN_CODE = '9090';
        
        // æ˜¾ç¤ºç®¡ç†å‘˜éªŒè¯
        function showAdminAuth() {
            document.getElementById('adminAuth').style.display = 'block';
            document.getElementById('adminCode').focus();
        }
        
        // éšè—ç®¡ç†å‘˜éªŒè¯
        function hideAdminAuth() {
            document.getElementById('adminAuth').style.display = 'none';
            document.getElementById('adminCode').value = '';
        }
        
        // éªŒè¯ç®¡ç†å‘˜ä»£ç 
        function verifyAdmin() {
            const inputCode = document.getElementById('adminCode').value;
            
            if (inputCode === ADMIN_CODE) {
                isAdminMode = true;
                
                // éšè—éªŒè¯ç•Œé¢
                hideAdminAuth();
                
                // æ˜¾ç¤ºç®¡ç†å‘˜åŠŸèƒ½åŒºåŸŸ
                document.getElementById('adminSection').style.display = 'block';
                
                // éšè—æ™®é€šç®¡ç†å‘˜æŒ‰é’®
                document.querySelector('.admin-panel').style.display = 'none';
                
                showAlert('âœ… ç®¡ç†å‘˜éªŒè¯æˆåŠŸï¼ç°åœ¨å¯ä»¥ä½¿ç”¨æ•°æ®ç®¡ç†åŠŸèƒ½', 'success');
                
                // ä¿å­˜ç®¡ç†å‘˜çŠ¶æ€ï¼ˆå¯é€‰ï¼šé¡µé¢åˆ·æ–°åéœ€è¦é‡æ–°éªŒè¯ï¼‰
                sessionStorage.setItem('adminMode', 'true');
                
            } else {
                showAlert('âŒ éªŒè¯ç é”™è¯¯ï¼è¯·è¾“å…¥æ­£ç¡®çš„ç®¡ç†å‘˜éªŒè¯ç ', 'warning');
                document.getElementById('adminCode').value = '';
                document.getElementById('adminCode').focus();
            }
        }
        
        // ç®¡ç†å‘˜æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllDataAdmin() {
            if (!isAdminMode) {
                showAlert('âŒ éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ', 'warning');
                return;
            }
            
            const confirmMsg = 'âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\n- æ‰€æœ‰å­¦ç”Ÿä¿¡æ¯\n- æ‰€æœ‰æµå¤±è®°å½•\n- æ‰€æœ‰ç­çº§çŠ¶æ€\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼';
            
            if (confirm(confirmMsg)) {
                const doubleConfirm = prompt('è¯·è¾“å…¥ "ç¡®è®¤åˆ é™¤" æ¥å®Œæˆæ“ä½œï¼š');
                
                if (doubleConfirm === 'ç¡®è®¤åˆ é™¤') {
                    try {
                        // æ¸…ç©ºæœ¬åœ°æ•°æ®
                        studentData = [];
                        dropoutData = {};
                        classStatus = {};
                        
                        // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
                        localStorage.removeItem('studentData');
                        localStorage.removeItem('dropoutData');
                        localStorage.removeItem('classStatus');
                        
                        // æ¸…ç©ºäº‘ç«¯æ•°æ®
                        const response = await fetch('/api/data', {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            showAlert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼äº‘ç«¯å’Œæœ¬åœ°æ•°æ®å·²åŒæ­¥åˆ é™¤', 'success');
                        } else {
                            showAlert('âš ï¸ æœ¬åœ°æ•°æ®å·²æ¸…ç©ºï¼Œä½†äº‘ç«¯æ¸…ç©ºå¯èƒ½å¤±è´¥', 'warning');
                        }
                        
                        // æ›´æ–°ç•Œé¢
                        updateDataInfo();
                        document.getElementById('collegeSelect').innerHTML = '<option value="">æš‚æ— æ•°æ®</option>';
                        document.getElementById('classSelect').innerHTML = '<option value="">è¯·å…ˆå¯¼å…¥æ•°æ®</option>';
                        
                        // éšè—ç®¡ç†å‘˜ç•Œé¢ï¼Œå›åˆ°æ™®é€šæ¨¡å¼
                        exitAdminMode();
                        
                    } catch (error) {
                        showAlert('âŒ æ¸…ç©ºæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼š' + error.message, 'danger');
                    }
                } else {
                    showAlert('æ“ä½œå·²å–æ¶ˆ', 'info');
                }
            }
        }
        
        // ç®¡ç†å‘˜å¯¼å‡ºæ•°æ®ï¼ˆæ— éœ€éªŒè¯ç ï¼‰
        function exportDataAdmin() {
            if (!isAdminMode) {
                showAlert('âŒ éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ', 'warning');
                return;
            }
            
            if (studentData.length === 0) {
                showAlert('âŒ æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆå¯¼å…¥å­¦ç”Ÿæ•°æ®', 'warning');
                return;
            }
            
            try {
                // å‡†å¤‡å¯¼å‡ºæ•°æ®
                const exportStudentData = studentData.map((student, index) => ({
                    'åºå·': index + 1,
                    'å§“å': student.name,
                    'æ€§åˆ«': student.gender,
                    'å­¦é™¢': student.collegeName,
                    'ç­çº§': student.className,
                    'ä¸“ä¸š': student.major,
                    'æ˜¯å¦æµå¤±': dropoutData[student.id] ? 'æ˜¯' : 'å¦',
                    'æµå¤±çŠ¶æ€': dropoutData[student.id] ? 'å·²æµå¤±' : 'æ­£å¸¸'
                }));
                
                // ç»Ÿè®¡æ±‡æ€»æ•°æ®
                const totalStudents = studentData.length;
                const dropoutCount = Object.values(dropoutData).filter(status => status).length;
                const normalCount = totalStudents - dropoutCount;
                
                const summaryData = [
                    {'é¡¹ç›®': 'æ€»å­¦ç”Ÿæ•°', 'æ•°å€¼': totalStudents},
                    {'é¡¹ç›®': 'å·²æµå¤±äººæ•°', 'æ•°å€¼': dropoutCount},
                    {'é¡¹ç›®': 'æ­£å¸¸äººæ•°', 'æ•°å€¼': normalCount},
                    {'é¡¹ç›®': 'æµå¤±ç‡', 'æ•°å€¼': `${(dropoutCount / totalStudents * 100).toFixed(2)}%`}
                ];
                
                const wb = XLSX.utils.book_new();
                
                // å­¦ç”Ÿè¯¦ç»†æ•°æ®
                const ws1 = XLSX.utils.json_to_sheet(exportStudentData);
                XLSX.utils.book_append_sheet(wb, ws1, "å­¦ç”Ÿè¯¦ç»†æ•°æ®");
                
                // ç»Ÿè®¡æ±‡æ€»
                const ws2 = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, ws2, "ç»Ÿè®¡æ±‡æ€»");
                
                const timestamp = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `å­¦ç”Ÿæµå¤±ç»Ÿè®¡_ç®¡ç†å‘˜å¯¼å‡º_${timestamp}.xlsx`);
                
                showAlert('âœ… Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼åŒ…å«å­¦ç”Ÿè¯¦ç»†æ•°æ®å’Œç»Ÿè®¡æ±‡æ€»', 'success');
                
            } catch (error) {
                showAlert('âŒ å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'warning');
            }
        }
        
        // é€€å‡ºç®¡ç†å‘˜æ¨¡å¼
        function exitAdminMode() {
            isAdminMode = false;
            document.getElementById('adminSection').style.display = 'none';
            document.querySelector('.admin-panel').style.display = 'block';
            sessionStorage.removeItem('adminMode');
        }
        
        // æ”¯æŒå›è½¦é”®ç¡®è®¤éªŒè¯ç 
        document.addEventListener('DOMContentLoaded', function() {
            const adminCodeInput = document.getElementById('adminCode');
            if (adminCodeInput) {
                adminCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyAdmin();
                    }
                });
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ç®¡ç†å‘˜æ¨¡å¼ï¼ˆé¡µé¢åˆ·æ–°åé‡ç½®ï¼‰
            if (sessionStorage.getItem('adminMode') === 'true') {
                // é¡µé¢åˆ·æ–°åé‡ç½®ä¸ºæ™®é€šæ¨¡å¼ï¼Œéœ€è¦é‡æ–°éªŒè¯
                sessionStorage.removeItem('adminMode');
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶å¯åŠ¨
        window.addEventListener('load', init);
    </script>
</body>
</html>